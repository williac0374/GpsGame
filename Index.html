<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Leaflet JS Location Tracker</title>
<!-- Leaflet CSS -->
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
<style>
#map {
  height: 100vh;
}
</style>
</head>
<body>
<audio id="powerupSound" src="Powerup.mp3" preload="auto"></audio>
<div id="map"></div>

<!-- Leaflet JS -->
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

<script>
function playPowerupSound() {
    const sound = document.getElementById('powerupSound');
    sound.currentTime = 0; // Reset the sound to the beginning
    sound.play(); // Play the sound
}
 var points = [
  {
    "lat": 40.13408546279508,
    "lon": -91.53016805648805
  },
  {
    "lat": 40.135135387952914,
    "lon": -91.53012514114381
  },
  {
    "lat": 40.136037654425564,
    "lon": -91.5301036834717
  },
  {
    "lat": 40.13595563069578,
    "lon": -91.52840852737428
  },
  {
    "lat": 40.135036958158445,
    "lon": -91.5283226966858
  },
  {
    "lat": 40.13405265237252,
    "lon": -91.52815103530884
  },
  {
    "lat": 40.13321598124515,
    "lon": -91.53012514114381
  },
  {
    "lat": 40.13318317040281,
    "lon": -91.52823686599733
  },
  {
    "lat": 40.132264460386075,
    "lon": -91.52817249298096
  },
  {
    "lat": 40.132264460386075,
    "lon": -91.53006076812746
  },
  {
    "lat": 40.131411361393255,
    "lon": -91.52825832366945
  },
  {
    "lat": 40.13223164908436,
    "lon": -91.52671337127686
  },
  {
    "lat": 40.131263708557434,
    "lon": -91.52664899826051
  },
  {
    "lat": 40.13219883776679,
    "lon": -91.52503967285156
  },
  {
    "lat": 40.13124730266699,
    "lon": -91.5249752998352
  },
  {
    "lat": 40.13029575424528,
    "lon": -91.52673482894897
  },
  {
    "lat": 40.12942622421124,
    "lon": -91.52664899826051
  },
  {
    "lat": 40.12936059885156,
    "lon": -91.5249752998352
  },
  {
    "lat": 40.13023012972515,
    "lon": -91.5249752998352
  },
  {
    "lat": 40.130164505141636,
    "lon": -91.52355909347534
  },
  {
    "lat": 40.13124730266699,
    "lon": -91.52353763580324
  },
  {
    "lat": 40.132215243427545,
    "lon": -91.52364492416382
  },
  {
    "lat": 40.12937700519743,
    "lon": -91.52353763580324
  },
  {
    "lat": 40.12934419250175,
    "lon": -91.52169227600099
  },
  {
    "lat": 40.12834339767418,
    "lon": -91.52156352996826
  },
  {
    "lat": 40.12840902401595,
    "lon": -91.52343034744264
  },
  {
    "lat": 40.12840902401595,
    "lon": -91.52501821517944
  },
  {
    "lat": 40.12791682490818,
    "lon": -91.52488946914674
  },
  {
    "lat": 40.127900418209876,
    "lon": -91.523494720459
  },
  {
    "lat": 40.127424622236354,
    "lon": -91.52343034744264
  },
  {
    "lat": 40.127424622236354,
    "lon": -91.51993274688722
  },
  {
    "lat": 40.12753946984524,
    "lon": -91.52160644531251
  },
  {
    "lat": 40.128359804265564,
    "lon": -91.52006149291992
  },
  {
    "lat": 40.12937700519743,
    "lon": -91.52004003524782
  },
  {
    "lat": 40.1301973174413,
    "lon": -91.52010440826416
  },
  {
    "lat": 40.130279348121185,
    "lon": -91.52182102203369
  },
  {
    "lat": 40.131181679065584,
    "lon": -91.52008295059204
  },
  {
    "lat": 40.13114886724114,
    "lon": -91.52169227600099
  },
  {
    "lat": 40.13219883776679,
    "lon": -91.52012586593628
  },
  {
    "lat": 40.13223164908436,
    "lon": -91.52175664901735
  },
  {
    "lat": 40.13318317040281,
    "lon": -91.52173519134523
  },
  {
    "lat": 40.13316676497571,
    "lon": -91.52343034744264
  },
  {
    "lat": 40.13318317040281,
    "lon": -91.52482509613039
  },
  {
    "lat": 40.13405265237252,
    "lon": -91.52488946914674
  },
  {
    "lat": 40.134069057585776,
    "lon": -91.52351617813112
  },
  {
    "lat": 40.134069057585776,
    "lon": -91.52169227600099
  },
  {
    "lat": 40.134069057585776,
    "lon": -91.52649879455568
  },
  {
    "lat": 40.135053363134084,
    "lon": -91.52632713317873
  },
  {
    "lat": 40.13498774320774,
    "lon": -91.52486801147462
  },
  {
    "lat": 40.13610327333807,
    "lon": -91.52471780776979
  },
  {
    "lat": 40.135053363134084,
    "lon": -91.52332305908205
  },
  {
    "lat": 40.135004148195264,
    "lon": -91.52179956436159
  },
  {
    "lat": 40.13498774320774,
    "lon": -91.52040481567384
  },
  {
    "lat": 40.13403624715531,
    "lon": -91.52040481567384
  },
  {
    "lat": 40.13403624715531,
    "lon": -91.51898860931398
  },
  {
    "lat": 40.13602124968752,
    "lon": -91.5190100669861
  },
  {
    "lat": 40.135036958158445,
    "lon": -91.51898860931398
  },
  {
    "lat": 40.136037654425564,
    "lon": -91.5204906463623
  },
  {
    "lat": 40.13607046388973,
    "lon": -91.52179956436159
  },
  {
    "lat": 40.136054059159605,
    "lon": -91.52319431304933
  },
  {
    "lat": 40.13716957178564,
    "lon": -91.5233874320984
  },
  {
    "lat": 40.137153167320875,
    "lon": -91.52194976806642
  },
  {
    "lat": 40.137087549422176,
    "lon": -91.52046918869019
  },
  {
    "lat": 40.13705474044906,
    "lon": -91.51926755905153
  },
  {
    "lat": 40.13831787447843,
    "lon": -91.5201473236084
  },
  {
    "lat": 40.13812102396639,
    "lon": -91.52179956436159
  },
  {
    "lat": 40.13810461973134,
    "lon": -91.52332305908205
  },
  {
    "lat": 40.138137428197524,
    "lon": -91.52465343475342
  },
  {
    "lat": 40.137235189605136,
    "lon": -91.52471780776979
  },
  {
    "lat": 40.13915448279221,
    "lon": -91.52476072311403
  },
  {
    "lat": 40.13917088677383,
    "lon": -91.52323722839355
  },
  {
    "lat": 40.1391216748171,
    "lon": -91.52182102203369
  },
  {
    "lat": 40.139236502660694,
    "lon": -91.5209197998047
  },
  {
    "lat": 40.13315035954464,
    "lon": -91.51894569396974
  },
  {
    "lat": 40.132248054737175,
    "lon": -91.5189027786255
  },
  {
    "lat": 40.13321598124515,
    "lon": -91.51759386062623
  },
  {
    "lat": 40.13231367730895,
    "lon": -91.51746511459352
  },
  {
    "lat": 40.13229727167193,
    "lon": -91.5160918235779
  },
  {
    "lat": 40.131263708557434,
    "lon": -91.51870965957642
  },
  {
    "lat": 40.13131292620502,
    "lon": -91.51748657226564
  },
  {
    "lat": 40.131362143816936,
    "lon": -91.51611328125001
  },
  {
    "lat": 40.13034497259381,
    "lon": -91.51870965957642
  },
  {
    "lat": 40.13034497259381,
    "lon": -91.51735782623291
  },
  {
    "lat": 40.13045981526841,
    "lon": -91.51607036590578
  },
  {
    "lat": 40.130443409183925,
    "lon": -91.51476144790651
  },
  {
    "lat": 40.12931137979023,
    "lon": -91.51864528656007
  },
  {
    "lat": 40.12947544318941,
    "lon": -91.51722908020021
  },
  {
    "lat": 40.1294590368673,
    "lon": -91.5159845352173
  },
  {
    "lat": 40.12852386996161,
    "lon": -91.51592016220093
  },
  {
    "lat": 40.12847465029437,
    "lon": -91.51722908020021
  },
  {
    "lat": 40.12840902401595,
    "lon": -91.51862382888795
  },
  {
    "lat": 40.12745743585868,
    "lon": -91.5185594558716
  },
  {
    "lat": 40.12753946984524,
    "lon": -91.51714324951173
  },
  {
    "lat": 40.127555876630666,
    "lon": -91.51585578918458
  },
  {
    "lat": 40.126473020298114,
    "lon": -91.51980400085449
  },
  {
    "lat": 40.12653864844569,
    "lon": -91.51849508285524
  },
  {
    "lat": 40.12658786951476,
    "lon": -91.51714324951173
  },
  {
    "lat": 40.12658786951476,
    "lon": -91.51587724685669
  },
  {
    "lat": 40.125652663107566,
    "lon": -91.51572704315187
  },
  {
    "lat": 40.125636255862794,
    "lon": -91.51695013046265
  },
  {
    "lat": 40.12555421957944,
    "lon": -91.518452167511
  },
  {
    "lat": 40.125537812310874,
    "lon": -91.51982545852663
  },
  {
    "lat": 40.124668221410914,
    "lon": -91.51969671249391
  },
  {
    "lat": 40.12473385130089,
    "lon": -91.51836633682251
  },
  {
    "lat": 40.1247666662221,
    "lon": -91.51720762252809
  },
  {
    "lat": 40.12475025876347,
    "lon": -91.51581287384035
  }
];

function isMobileBrowser() {
  const userAgent = navigator.userAgent || navigator.vendor || window.opera;
  return /android|avantgo|blackberry|bada|iphone|ipad|ipod|iemobile|opera mini|opera mobi|webos|mobile/i.test(userAgent);
}
//var lat = 40.134995;
//var lon = -91.526652;
//let currentLocation = [lat, lon]; // Default location
const move = 0.00005;
// Initialize the map and set view to a default location
var map = L.map('map').setView([lat,lon], 19);
var tick = 0;
// Add a satellite layer to the map using OpenStreetMap
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
maxZoom: 19
}).addTo(map);

// Declare a variable to hold the user's marker
var userMarker = null;
var flagDrop=false;
var flags = [];
var markers = [];
var info = "you are here"
// Function to update the location marker
function onLocationFound(e) {
// if (isMobileBrowser()) {
  currentLocation = e.latlng;
  checkMarkers(8);
// } 
// If the marker doesn't exist yet, create it
if (!userMarker) {
  userMarker = L.marker(currentLocation).addTo(map)
  map.setView(currentLocation, 19);
  // Create and bind the popup
  userMarker.bindPopup(info).openPopup();
} else {
  // If the marker exists, move it to the new location
  userMarker.setLatLng(currentLocation);

  
  //uaerMarker.bindPopup("You are here NOW").openPopup();
}


}
// Function to add a red marker at mouse position
function addMarker(e) {

var plant=false;
if (plant) {
flags.push({lat:e.latlng.lat,lon:e.latlng.lng})
  // Create a red marker
  markers[flags.length-1]= L.circleMarker(e.latlng, {
    color: 'red',
    radius: 6
  }).addTo(map);
  playPowerupSound();
}
}

function allPoints(){
  for (let i = 0; i < points.length; i++) {
      // Create a red marker
  markers[i] = L.circleMarker([points[i].lat,points[i].lon], {
    color: 'blue',
    radius: 4
  }).addTo(map);
  }
}
allPoints()
// Add event listener for map clicks
map.on('click', addMarker);

function onLocationError(e) {
alert(e.message);
}

// Set up map events for location tracking
map.on('locationfound', onLocationFound);
map.on('locationerror', onLocationError);

// Start watching the user's location with enhanced accuracy settings
map.locate({
watch: true,
enableHighAccuracy: true, // Request high-accuracy GPS
timeout: 30000, // Wait up to 10 seconds for a response
maximumAge: 0 // Do not use cached location data
});

// Move the map using arrow keys
window.addEventListener('keydown', (e) => {
switch (e.key) {
  
  case ' ':

  break;
  case 'Enter':
  
  break;
  case 'w':
  currentLocation[0] += move;checkMarkers(8);
  
  break;
  case 's':
  currentLocation[0] -= move;checkMarkers(8);
  
  break;
  case 'a':
  currentLocation[1] -= move;checkMarkers(8);
  
  break;
  case 'd':
  currentLocation[1] += move;checkMarkers(8);
  
  break;
  default:
  return; // Exit this handler for other keys
}
userMarker.setLatLng(currentLocation);
map.setView(currentLocation, map.getZoom());
});
window.addEventListener('keyup', (e) => {
if(e.key==' '){
  flagDrop=false;
}
if(e.key=='Enter'){
  console.log(JSON.stringify(flags, null, 2))
}
});
function checkNear(distance){
var possibleFlags = []
var closeMarkers = []
//{lat:e.latlng.lat,lon:e.latlng.lng,kill:false}
for (let i = 0; i < flags.length; i++) {
  if(proximity(flags[i].lat, flags[i].lon, currentLocation[0], currentLocation[1], distance)){
    possibleFlags.push(flags[i])
  }
}
  for (let i = 0; i < possibleFlags.length; i++) {
    markers[i].setStyle({ color: "green" });
  // Create a red marker
  closeMarkers[i]= L.circleMarker([possibleFlags[i].lat,possibleFlags[i].lon], {
    color: 'purple',
    radius: 6
  }).addTo(map);
}
}
function checkMarkers(dis){
for (let i = 0; i < markers.length; i++) {
  if (proximity(markers[i]._latlng.lat, markers[i]._latlng.lng, currentLocation[0], currentLocation[1],dis)){
  map.removeLayer(markers[i]);
    markers.splice(i,1)
    playPowerupSound();
  }
}
}
//There are approximately 1,609.34 meters in a mile.
//qmile=400
function proximity(latA, lonA, latB, lonB, meters) {
// Create LatLng objects for both points
var pointA = L.latLng(latA, lonA);
var pointB = L.latLng(latB, lonB);

// Calculate the distance in meters
var distance = pointA.distanceTo(pointB);

// Return true if within 12 meters
return distance <= meters;
}

</script>

</body>
</html>
