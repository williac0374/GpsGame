<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Leaflet GPS Location with Target</title>

    <!-- Leaflet CSS and JS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <!-- Web App Manifest -->
    <link rel="manifest" href="/manifest.json">

    <!-- PWA Metadata -->
    <meta name="theme-color" content="#ffffff">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="apple-touch-icon" href="/icons/icon-192x192.png">

    <style>
        #map {
            height: 100vh;
            width: 100%;
            margin: 0;
        }
        body, html {
            margin: 0;
            padding: 0;
            height: 100%;
            width: 100%;
        }
    </style>
</head>
<body>
    <div id="map"></div>

    <script>
        let map, currentMarker, targetCircle;
        let targetRadius = 10;
        let targetLatLng;

        function initMap() {
            map = L.map('map').setView([0, 0], 16);

            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                maxZoom: 19,
                attribution: 'Â© OpenStreetMap'
            }).addTo(map);

            if (navigator.geolocation) {
                navigator.geolocation.watchPosition(updateLocation, handleError, {
                    enableHighAccuracy: true,
                    maximumAge: 0,
                    timeout: 5000
                });
            } else {
                alert("Geolocation is not supported by this browser.");
            }
        }

        function updateLocation(position) {
            const lat = position.coords.latitude;
            const lng = position.coords.longitude;
            const currentLatLng = [lat, lng];

            if (!currentMarker) {
                currentMarker = L.circleMarker(currentLatLng, {
                    radius: 2,
                    color: 'green',
                    fillColor: 'green',
                    fillOpacity: 1
                }).addTo(map);

                map.setView(currentLatLng);

                resetTarget(currentLatLng);
            } else {
                currentMarker.setLatLng(currentLatLng);
            }

            increaseTargetSize();

            if (map.distance(currentLatLng, targetLatLng) < targetRadius) {
                resetTarget(currentLatLng);
            }
        }

        function handleError(error) {
            console.warn(`ERROR(${error.code}): ${error.message}`);
        }

        function resetTarget(currentLatLng) {
            targetRadius = 10;

            const quarterMileInMeters = 402.336;
            const randomDistance = Math.random() * quarterMileInMeters;
            const randomAngle = Math.random() * 2 * Math.PI;

            const offsetLat = randomDistance * Math.cos(randomAngle) / 111320;
            const offsetLng = randomDistance * Math.sin(randomAngle) / (111320 * Math.cos(currentLatLng[0] * (Math.PI / 180)));

            targetLatLng = [currentLatLng[0] + offsetLat, currentLatLng[1] + offsetLng];

            if (!targetCircle) {
                targetCircle = L.circle(targetLatLng, {
                    color: 'red',
                    fillColor: '#f03',
                    fillOpacity: 0.5,
                    radius: targetRadius
                }).addTo(map);
            } else {
                targetCircle.setLatLng(targetLatLng);
                targetCircle.setRadius(targetRadius);
            }
        }

        function increaseTargetSize() {
            targetRadius += 0.1;
            targetCircle.setRadius(targetRadius);
        }

        window.onload = initMap;
    </script>
</body>
</html>
